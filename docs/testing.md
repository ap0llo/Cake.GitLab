<!--
GENERATED FILE - DO NOT EDIT
This file was generated by [MarkdownSnippets](https://github.com/SimonCropp/MarkdownSnippets).
Source File: /docs/testing.source.md
To change this file edit the source file and then run MarkdownSnippets.
-->

# Testing

`Cake.GitLab` is based on the [NGitLab library](https://github.com/ubisoft/NGitLab) which provides support for testing through the [NGitLab.Mock](https://www.nuget.org/packages/NGitLab.Mock) package.

This packages provides test doubles for many of `NGitLab`'s types and can be used to mock a GitLab server in your application or Cake Build.

`Cake.GitLab` provides the `IGitLabClientFactory` interface, which - when implemented by the Cake context - allows controlling the initializaiton of the `IGitLabClient` that is used by the GitLab aliases.

This can be used to inject a mocked GitLab client into the aliases in unit tests.

The following snippet shows an example of an (xunit-based) unit test that follows this approach.

<!-- snippet: Example-Testing -->
<a id='snippet-Example-Testing'></a>
```cs
[Fact]
public async Task GitLab_mocking_example()
{
    //
    // ARRANGE
    //

    // Create a mock GitLab server (using NGitLab.Mock library)
    var gitLabConfig =
        new GitLabConfig() { Url = "https://example.com" }
            .WithUser("user1", isDefault: true)
            .WithGroup("example-group")
            .WithProjectOfFullPath(
                fullPath: "example-project",
                id: 23,
                configure: project =>
                {
                    project.DefaultBranch = "example-branch";
                    project.WithCommit("Intial commit");
                }
            );

    // Create a mock ICakeContext
    var contextMock = new Mock<ICakeContext>();
    {
        // Add implementation of IGitlabClientFactory to the context
        contextMock
            .As<IGitLabClientFactory>()
            .Setup(x => x.GetClient(It.IsAny<string>(), It.IsAny<string>()))
            .Returns(gitLabConfig.BuildClient());

        var log = new FakeLog();
        contextMock.Setup(x => x.Log).Returns(log);

        var fileSystem = new FakeFileSystem(FakeEnvironment.CreateUnixEnvironment());
        contextMock.Setup(x => x.FileSystem).Returns(fileSystem);
    }

    //
    // ACT
    //
    var branches = await contextMock.Object.GitLabRepositoryGetBranchesAsync("https://example.com", "ACCESSTOKEN", 23);

    //
    // ASSERT
    //
    Assert.Collection(
        branches,
        branch => Assert.Equal("example-branch", branch.Name)
    );
}
```
<sup><a href='/examples/Testing/UnitTestExample.cs#L9-L63' title='Snippet source file'>snippet source</a> | <a href='#snippet-Example-Testing' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

## See Also

- [GitLab Client Factory](./client-factory.md)
